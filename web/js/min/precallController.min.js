(e=>{let t,o,i;const l={publishAudio:!0,publishVideo:!0,name:"",width:"100%",height:"100%",insertMode:"append",showControls:!1},n=window.localStorage.getItem("audioDeviceId"),s=window.localStorage.getItem("videoDeviceId");n&&(l.audioSource=n),s&&(l.videoSource=s);const a={"roomView:endprecall":()=>{Utils.sendEvent("PrecallController:endPrecall")}};e.PrecallController={init:()=>new Promise(e=>{LazyLoader.dependencyLoad(["/js/helpers/ejsTemplate.js","/js/vendor/ejs_production.js","/js/min/precallView.min.js"]).then(()=>(Utils.addEventsHandlers("",a),PrecallView.init())).then(()=>{e()})}),showCallSettingsPrompt:function(n,s,a){const r=".user-name-modal",d={toggleFacingMode(){a.toggleFacingMode().then(e=>{const t=e.deviceId;l.videoSource=t,window.localStorage.setItem("videoDeviceId",t)})},setAudioSource(e){const t=e.detail;a.setAudioSource(t),l.audioSource=t,window.localStorage.setItem("audioDeviceId",t)},initialAudioSwitch(e){o.publishAudio(e.detail.status),l.publishAudio=e.detail.status},initialVideoSwitch(e){o.publishVideo(e.detail.status),l.publishVideo=e.detail.status},retest(){PrecallView.startPrecallTestMeter(),t.startNetworkTest((e,t)=>{e||PrecallView.displayNetworkTestResults(t)})},cancelTest(){PrecallView.hideConnectivityTest(),t.stopTest()}};return new Promise(c=>{if(window.routedFromStartMeeting)return l.name=window.userName||document.querySelector(r+" input").value.trim(),c({username:window.userName||document.querySelector(r+" input").value.trim(),publisherOptions:l});a.otLoaded.then((function(){function u(){PrecallView.hide(),o&&o.destroy(),Utils.isIE()||t&&t.stopTest();const e=document.querySelector(r+" input").value.trim();window.localStorage.setItem("username",e),l.name=e,setTimeout(()=>{c({username:e,publisherOptions:l})},1)}function w(){window.location.href.indexOf("room")>-1?new Promise((e,t)=>{Request.getRoomRawInfo(n).then(o=>window.routedFromStartMeeting?e():showUnavailable&&!o?t(new Error("New rooms not allowed")):o&&!o.isLocked?e():showUnavailable||o?o&&o.isLocked?t(new Error("Room locked")):t(new Error("Unknown Room State")):e())}).then(()=>{showTos?PrecallView.showContract().then(u):u()}).catch(e=>{"Room locked"===e.message?PrecallView.showLockedMessage():PrecallView.showUnavailableMessage()}):showTos?PrecallView.showContract().then(()=>{Utils.sendEvent("precallView:submit")}):Utils.sendEvent("precallView:submit")}PrecallView.setFocus(s),(Utils.isIE()||Utils.isSafariIOS())&&window.enablePrecallTest&&PrecallView.hideConnectivityTest(),document.querySelector(".user-name-modal #enter").disabled=!1,document.querySelector(".user-name-modal").addEventListener("keypress",e=>{13===e.which&&(e.preventDefault(),w())}),document.querySelector(".user-name-modal").addEventListener("submit",e=>{e.preventDefault(),w()}),a.initPublisher("video-preview",l).then(n=>{o=n,a.getVideoDeviceNotInUse(l.videoSource).then(e=>{i={apiKey:window.precallApiKey,resolution:"640x480",sessionId:window.precallSessionId,token:window.precallToken,videoSource:e},o.on("accessAllowed",()=>{a.getDevices("audioInput").then(e=>{PrecallView.populateAudioDevicesDropdown(e,l.audioSource)}),Utils.isIE()||Utils.isSafariIOS()||!window.enablePrecallTest||(PrecallView.startPrecallTestMeter(),t=new OTNetworkTest(i),t.startNetworkTest((e,t)=>{PrecallView.displayNetworkTestResults(t),t.audioOnly&&(o.publishVideo(!1),Utils.sendEvent("PrecallController:audioOnly"))}))})}),Utils.addEventsHandlers("roomView:",d,e);let s=null;o.on("audioLevelUpdated",e=>{s=null===s||s<=e.audioLevel?e.audioLevel:.8*s+.2*e.audioLevel;let t=Math.log(s)/Math.LN10/1.5+1;t=Math.min(Math.max(t,0),1),PrecallView.setVolumeMeterLevel(t)})});const m=document.getElementById("user-name-input"),h=window.localStorage.getItem("username");s?(document.getElementById("enter-name-prompt").style.display="none",m.value=s,m.setAttribute("readonly",!0)):h&&(m.value=h,document.querySelector("#enter-name-prompt label").classList.add("visited"))}))})}}})(this);